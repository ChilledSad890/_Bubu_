<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bubu's Otherworldly Wish Quest</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: Arial, sans-serif; }
        canvas { display: block; width: 100vw; height: 100vh; }
        #ui { position: absolute; top: 10px; left: 10px; color: #fff; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 5px; }
        #question { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); padding: 20px; text-align: center; color: #fff; border-radius: 10px; max-width: 90vw; }
        button { margin: 5px; padding: 10px; background: #4CAF50; color: white; border: none; cursor: pointer; }
        #wish { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: url('https://via.placeholder.com/1920x1080/000/fff?text=Starry+Sky') no-repeat center; background-size: cover; text-align: center; color: #fff; font-size: 18px; padding-top: 100px; overflow-y: auto; }
        #uploadedImage { max-width: 80vw; max-height: 300px; border: 2px solid #fff; margin: 20px auto; display: block; }
        #muteBtn { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: #fff; border: none; padding: 10px; cursor: pointer; }
        /* Mobile Controls */
        #controls { position: absolute; bottom: 20px; left: 20px; display: none; }
        #controls button { width: 50px; height: 50px; font-size: 20px; margin: 5px; }
        #lookArea { position: absolute; bottom: 20px; right: 20px; width: 150px; height: 150px; background: rgba(255,255,255,0.1); border-radius: 50%; display: none; touch-action: none; }
        @media (max-width: 768px) {
            #controls, #lookArea { display: block; }
            #ui { font-size: 14px; }
        }
    </style>
</head>
<body>
    <button id="muteBtn" onclick="toggleMute()">Mute Music</button>
    <div id="ui">
        <p>Level: <span id="level">1</span></p>
        <p>Heart Shards: <span id="shards">0</span></p>
    </div>
    <div id="question">
        <p id="qText">Question here?</p>
        <button onclick="answer(0)">Option 1</button>
        <button onclick="answer(1)">Option 2</button>
        <button onclick="answer(2)">Option 3</button>
    </div>
    <div id="wish">
        <h1>Happy Birthday, Bubu!</h1>
        <p>My wish for you: A lifetime of happiness and adventures together. ❤️</p>
        <img id="uploadedImage" src="https://drive.google.com/file/d/1AUDK2GeGQjTcfxl_UVcjo-UxojF3Bd8a/uc?export=view" alt="Your Special Image" style="display: block;">
        <button onclick="restart()">Play Again</button>
    </div>
    <!-- Mobile Controls -->
    <div id="controls">
        <button id="up">↑</button><br>
        <button id="left">←</button><button id="right">→</button><br>
        <button id="down">↓</button>
    </div>
    <div id="lookArea"></div>
    <!-- Audio Elements -->
    <audio id="bgMusic" loop>
        <source src="https://www.soundjay.com/misc/sounds/bell-ringing-05.wav" type="audio/wav"> <!-- Placeholder: Replace with Genshin-like orchestral track (e.g., from Freesound.org) -->
    </audio>
    <audio id="collectSound">
        <source src="https://www.soundjay.com/button/sounds/beep-07.wav" type="audio/wav"> <!-- Chime for collecting -->
    </audio>
    <audio id="answerSound">
        <source src="https://www.soundjay.com/misc/sounds/bell-ringing-01.wav" type="audio/wav"> <!-- Bell for answering -->
    </audio>
    <audio id="levelUpSound">
        <source src="https://www.soundjay.com/misc/sounds/applause-01.wav" type="audio/wav"> <!-- Fanfare for level up -->
    </audio>
    <audio id="wishSound">
        <source src="https://www.soundjay.com/misc/sounds/magic-chime-01.wav" type="audio/wav"> <!-- Magical for wish -->
    </audio>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Audio Setup
        const bgMusic = document.getElementById('bgMusic');
        const collectSound = document.getElementById('collectSound');
        const answerSound = document.getElementById('answerSound');
        const levelUpSound = document.getElementById('levelUpSound');
        const wishSound = document.getElementById('wishSound');
        let isMuted = false;

        function toggleMute() {
            isMuted = !isMuted;
            bgMusic.muted = isMuted;
            collectSound.muted = isMuted;
            answerSound.muted = isMuted;
            levelUpSound.muted = isMuted;
            wishSound.muted = isMuted;
            document.getElementById('muteBtn').textContent = isMuted ? 'Unmute Music' : 'Mute Music';
        }

        // Start background music
        bgMusic.volume = 0.3;
        bgMusic.play().catch(() => {}); // Auto-play may be blocked on some browsers

        // Controls: Desktop and Mobile
        let isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        let controls;
        if (!isMobile) {
            controls = new THREE.PointerLockControls(camera, document.body);
            document.addEventListener('click', () => controls.lock());
            document.addEventListener('keydown', (e) => {
                if (e.key === 'w') controls.moveForward(0.1);
                if (e.key === 's') controls.moveForward(-0.1);
                if (e.key === 'a') controls.moveRight(-0.1);
                if (e.key === 'd') controls.moveRight(0.1);
            });
        } else {
            controls = { moveForward: (d) => camera.translateZ(-d), moveRight: (d) => camera.translateX(d), rotateY: (r) => camera.rotation.y += r };
            document.getElementById('up').addEventListener('touchstart', () => controls.moveForward(0.1));
            document.getElementById('down').addEventListener('touchstart', () => controls.moveForward(-0.1));
            document.getElementById('left').addEventListener('touchstart', () => controls.moveRight(-0.1));
            document.getElementById('right').addEventListener('touchstart', () => controls.moveRight(0.1));
            let touchStartX = 0;
            document.getElementById('lookArea').addEventListener('touchstart', (e) => touchStartX = e.touches[0].clientX);
            document.getElementById('lookArea').addEventListener('touchmove', (e) => {
                const deltaX = e.touches[0].clientX - touchStartX;
                controls.rotateY(deltaX * 0.01);
                touchStartX = e.touches[0].clientX;
            });
        }

        // Levels
        const levels = [
            { sky: 0x90EE90, ground: new THREE.PlaneGeometry(100, 100), texture: 'https://via.placeholder.com/512x512/90EE90/000?text=Grass' },
            { sky: 0xADD8E6, ground: new THREE.PlaneGeometry(100, 100), texture: 'https://via.placeholder.com/512x512/ADD8E6/000?text=Crystal' },
            { sky: 0x708090, ground: new THREE.PlaneGeometry(100, 100), texture: 'https://via.placeholder.com/512x512/708090/000?text=Mountain' },
            { sky: 0x228B22, ground: new THREE.PlaneGeometry(100, 100), texture: 'https://via.placeholder.com/512x512/228B22/000?text=Forest' },
            { sky: 0x000080, ground: new THREE.PlaneGeometry(100, 100), texture: 'https://via.placeholder.com/512x512/000080/fff?text=Stars' }
        ];

        let currentLevel = 0;
        let shards = 0;
        let qIndex = 0;
        let answered = false;

        function loadLevel() {
            scene.clear();
            scene.background = new THREE.Color(levels[currentLevel].sky);
            const textureLoader = new THREE.TextureLoader();
            const groundTexture = textureLoader.load(levels[currentLevel].texture);
            const ground = new THREE.Mesh(levels[currentLevel].ground, new THREE.MeshBasicMaterial({ map: groundTexture }));
            ground.rotation.x = -Math.PI / 2;
            scene.add(ground);

            for (let i = 0; i < 5; i++) {
                const shard = new THREE.Mesh(new THREE.SphereGeometry(0.5), new THREE.MeshBasicMaterial({ color: 0xff0000 }));
                shard.position.set(Math.random() * 20 - 10, 1, Math.random() * 20 - 10);
                shard.userData = { collected: false };
                scene.add(shard);
            }
        }

        loadLevel();

        // Full Questions
        const questions = [
            [
                { q: "What's your favorite memory of us laughing together?", o: ["A silly dance", "A picnic fail", "Something custom"], correct: -1 },
                { q: "If you could fly like the wind, where would you go first?", o: ["The beach", "Mountains", "Home"], correct: -1 },
                { q: "What's one thing that always makes you smile?", o: ["Puppies", "Your smile", "Cake"], correct: -1 }
            ],
            [
                { q: "What's your superpower in real life?", o: ["Kindness", "Creativity", "Laughter"], correct: -1 },
                { q: "If we were in a cave adventure, what treasure would you want?", o: ["A heart-shaped gem", "Gold coins", "A magic map"], correct: -1 },
                { q: "What's a dream you've always had?", o: ["Travel the world", "Start a family", "Learn something new"], correct: -1 }
            ],
            [
                { q: "What's the bravest thing you've done?", o: ["Try new things", "Face fears", "Love deeply"], correct: -1 },
                { q: "If you could control lightning, what would you change in the world?", o: ["End injustice", "Bring peace", "Create art"], correct: -1 },
                { q: "What's one thing I do that makes you feel loved?", o: ["Surprise you", "Listen always", "Make you laugh"], correct: -1 }
            ],
            [
                { q: "What's your favorite way to relax?", o: ["Reading", "Walking", "With you"], correct: -1 },
                { q: "If we could live in a magical forest, what would our home look like?", o: ["Treehouse", "Crystal palace", "Cozy cabin"], correct: -1 },
                { q: "What's a compliment you've never forgotten?", o: ["You're amazing", "You're kind", "You're strong"], correct: -1 }
            ],
            [
                { q: "What's your biggest wish for the future?", o: ["Happiness", "Adventure", "Love"], correct: -1 },
                { q: "If you could grant me one wish, what would it be?", o: ["For us to be together", "For your dreams", "For joy"], correct: -1 },
                { q: "What's the most amazing thing about you?", o: ["Your heart", "Your smile", "Your spirit"], correct: -1 }
            ]
        ];

        function showQuestion() {
            if (qIndex >= questions[currentLevel].length) return;
            const q = questions[currentLevel][qIndex];
            document.getElementById('qText').textContent = q.q;
            const buttons = document.querySelectorAll('#question button');
            buttons.forEach((btn, i) => btn.textContent = q.o[i] || 'N/A');
            document.getElementById('question').style.display = 'block';
            answered = false;
        }

        function answer(choice) {
            if (answered) return;
            answered = true;
            document.getElementById('question').style.display = 'none';
            answerSound.play().catch(() => {});
            qIndex++;
        }

        function showWish() {
            document.getElementById('wish').style.display = 'block';
            bgMusic.volume = 0.1; // Fade music
            wishSound.play().catch(() => {});
        }

        function animate() {
            requestAnimationFrame(animate);
            scene.children.forEach(child => {
                if (child.geometry && child.geometry.type === 'SphereGeometry' && !child.userData.collected) {
                    const distance = camera.position.distanceTo(child.position);
                    if (distance < 2) {
                        child.userData.collected = true;
                        scene.remove(child);
                        shards++;
                        document.getElementById('shards').textContent = shards;
                        collectSound.play().catch(() => {});
                        showQuestion();
                    }
                }
            });

            if (shards >= 5 && currentLevel < 4) {
                currentLevel++;
                shards = 0;
                document.getElementById('level').textContent = currentLevel + 1;
                loadLevel();
                qIndex = 0;
                levelUpSound.play().catch(() => {});
            } else if (currentLevel === 4 && shards >= 5) {
                showWish();
            }

            renderer.render(scene, camera);
        }

        animate();

        function restart() {
            location.reload();
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>